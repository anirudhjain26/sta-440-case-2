---
title: "STA 440 Case 2"
author: "Krish Bansal, Lily Seelig, Anirudh Jain"
# format: pdf
format: 
  pdf:
    documentclass: article 
    fontsize: 11pt         
    classoption: oneside       
editor: visual
geometry: margin=1in
title-block-spacing: compact
execute: 
  echo: false
  warning: false
  message: false
---

```{r, message=FALSE}
# imports
library(readr)
library(tidyverse)
library(patchwork)
library(scales)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(broom)
```

# Introduction

# Data

```{r, message=FALSE}

raw <- read_csv("data/JO2.csv", col_names = FALSE, show_col_types = FALSE)

header1 <- as.character(unlist(raw[1, ]))  # substrates in row 1
header2 <- as.character(unlist(raw[2, ]))  # doses in row 2

sub <- header1
sub[1] <- "Subject"
for (i in 2:length(sub)) {
  if (is.na(sub[i]) || sub[i] == "") sub[i] <- sub[i - 1]
}

dose <- header2
dose[1] <- NA  # first col is Subject

new_names <- c("Subject", paste(sub[-1], dose[-1], sep = "_"))

dat <- raw[-c(1, 2), ]
names(dat) <- new_names
dat <- dat %>% mutate(across(-Subject, ~ suppressWarnings(as.numeric(.))))

data_long <- dat %>%
  pivot_longer(
    cols = -Subject,
    names_to = c("Substrate", "Dose"),
    names_sep = "_",
    values_to = "JO2"
  ) %>%
  filter(Dose != "Basal") %>%
  mutate(
    Genotype = if_else(str_detect(Subject, "^NT"), "NT", "Tg"),
    Dose_num = as.numeric(Dose), 
    Dose = factor(Dose,
                  levels = c("Basal", "-12.95","-13.65","-13.95","-14.19","-14.36","-14.49"),
                  ordered = TRUE)
  ) %>%
  drop_na(JO2)   

```

```{r}
glimpse(data_long)
```

# Exploratory Data Analysis

```{r}
#| label: histograms

# Raw JO2
hist(
  data_long$JO2,
  breaks = 60,
  main = "Distribution of Raw JO2 Values",
  xlab = "Oxygen Consumption (JO2, pmol/min)",
  ylab = "Frequency",
  col = "lightblue",
  border = "white"
)

# Log10-transformed JO2
hist(
  log10(data_long$JO2),
  breaks = 60,
  main = "Distribution of Log Transformed JO2 Values",
  xlab = "Log(Oxygen Consumption, JO2)",
  ylab = "Frequency",
  col = "lightgreen",
  border = "white"
)

data_long <- data_long %>%
  mutate(logJO2 = log10(JO2))

```

```{r}

# Keep Dose numeric
data_long <- data_long %>%
  mutate(Dose = as.numeric(as.character(Dose)))

summary_data <- summary_data %>%
  mutate(Dose = as.numeric(as.character(Dose)))

# Get all unique doses
all_doses <- sort(unique(data_long$Dose))

# Plot individual lines with exact dose labels
ggplot(data_long, aes(x = Dose, y = JO2, color = Genotype, group = Subject)) +
  geom_line(alpha = 0.5) +
  facet_wrap(~ Substrate, scales = "free_y", labeller = label_wrap_gen(width = 15)) +
  scale_x_continuous(breaks = all_doses) +  # show all doses exactly
  theme_minimal() +
  labs(title = "JO2 across Dose by Substrate and Genotype") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    strip.text = element_text(size = 9)
  )

# Plot genotype means ± SE with exact dose labels
ggplot(summary_data, aes(Dose, mean_JO2, color = Genotype, group = Genotype)) +
  geom_line() + 
  geom_point() +
  geom_errorbar(aes(ymin = mean_JO2 - se, ymax = mean_JO2 + se), width = 0.1) +
  facet_wrap(~ Substrate, scales = "free_y", labeller = label_wrap_gen(width = 15)) +
  scale_x_continuous(breaks = all_doses) +  # show all doses exactly
  theme_minimal() +
  labs(title = "Mean JO2 ± SE", y = "Mean JO2") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    strip.text = element_text(size = 9)
  )

```

```{r}
data_long %>%
  filter(Dose %in% c("Basal", "-12.95")) %>%
  group_by(Genotype, Substrate, Dose) %>%
  summarise(mean_JO2 = mean(JO2), se = sd(JO2)/sqrt(n()), .groups = "drop") %>%
  ggplot(aes(x = Dose, y = mean_JO2, fill = Genotype)) +
  geom_col(position = position_dodge()) +
  geom_errorbar(aes(ymin = mean_JO2-se, ymax = mean_JO2+se),
                width = 0.2, position = position_dodge(0.9)) +
  facet_wrap(~Substrate, scales = "free_y") +
  theme_minimal()
```

```{r}
slopes <- data_long %>%
  group_by(Subject, Genotype, Substrate) %>%
  do(tidy(lm(JO2 ~ Dose_num, data = .))) %>%
  filter(term == "Dose_num")

ggplot(slopes, aes(x = Substrate, y = estimate, fill = Genotype)) +
  geom_boxplot(alpha = 0.6, position = position_dodge()) +
  theme_minimal() +
  labs(y = "Slope of JO2 vs Dose", title = "Respiratory sensitivity by Genotype") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10)  # rotate labels
  )
```

```{r}
heat <- data_long %>%
  group_by(Substrate, Dose, Genotype) %>%
  summarise(mean_JO2 = mean(JO2), .groups = "drop")

ggplot(heat, aes(x = Dose, y = Substrate, fill = mean_JO2)) +
  geom_tile() +
  facet_wrap(~Genotype) +
  scale_fill_viridis_c() +
  theme_minimal() +
  labs(title = "Heatmap of mean JO2 across Substrates & Doses") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # rotate x labels
  )
```

# Log Transformed EDA

```{r}
ggplot(data_long, aes(x = Dose, y = logJO2, color = Genotype, group = Subject)) +
  geom_line(alpha = 0.5) +
  facet_wrap(~ Substrate, scales = "free_y", labeller = label_wrap_gen(width = 15)) +
  theme_minimal() +
  labs(title = "Log(JO2) across Dose by Substrate and Genotype") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),  # rotate dose labels
    strip.text = element_text(size = 9)  # control facet label size
  )

# genotype means ± SE per substrate×dose
summary_data <- data_long %>%
  group_by(Substrate, Dose, Genotype) %>%
  summarise(mean_log_JO2 = mean(logJO2), se = sd(logJO2)/sqrt(n()), .groups = "drop")

ggplot(summary_data, aes(Dose, mean_log_JO2, color = Genotype, group = Genotype)) +
  geom_line() + 
  geom_point() +
  geom_errorbar(aes(ymin = mean_log_JO2 - se, ymax = mean_log_JO2 + se), width = 0.1) +
  facet_wrap(~ Substrate, scales = "free_y", labeller = label_wrap_gen(width = 15)) + # wrap long facet labels
  theme_minimal() +
  labs(title = "Mean log(JO2) ± SE", y = "Mean log(JO2)") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),  # fix dose labels
    strip.text = element_text(size = 9)                           # fix facet labels
  )
```

```{r}
heat <- data_long %>%
  group_by(Substrate, Dose, Genotype) %>%
  summarise(mean_log_JO2 = mean(logJO2), .groups = "drop")

ggplot(heat, aes(x = Dose, y = Substrate, fill = mean_log_JO2)) +
  geom_tile() +
  facet_wrap(~Genotype) +
  scale_fill_viridis_c() +
  theme_minimal() +
  labs(title = "Heatmap of mean log(JO2) across Substrates & Doses") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # rotate x labels
  )
```

# Model

# Results

# Conclusion

# Limitations and Future Work

\newpage

# Appendix
