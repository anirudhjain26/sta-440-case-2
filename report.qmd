---
title: "STA 440 Case 2"
author: "Krish Bansal, Lily Seelig, Anirudh Jain"
# format: pdf
format: 
  pdf:
    documentclass: article 
    fontsize: 11pt         
    classoption: oneside       
editor: visual
geometry: margin=1in
title-block-spacing: compact
execute: 
  echo: false
  warning: false
  message: false
---

```{r, message=FALSE}
# imports
library(readr)
library(tidyverse)
library(patchwork)
library(scales)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(broom)
library(car)
library(lme4)
library(lmerTest)
```

## Background

Mitochondria play a central role in cellular energy metabolism, and alterations in their molecular structures san translate into measurable physiological phenotypes. Characterizing how mitochondrial efficiency changes under different conditions provides important insights into metabolic function and disease mechanisms. 

To this end, researchers often measure mitochondrial respiration under a variety of experimental settings. Multiplexed metabolic assay platforms allow simultaneous evaluation of several aspects of mitochondrial functions across substrates, redox conditions, and energetic states. One critical readout is oxygen flux (JO2), which serves as a direct indicator of mitochondrial respiratory activity. Comparing oxygen flux between experimental groups such as non transgenic and transgenic mice provides a way to evaluate whether genetic differences are associated with altered mitochondrial functions. 

Our analysis focuses on modeling and testing for genotype effects on oxygen flux, while accounting for experimental design factors such as substrate type. The aim is to determine whether mitochondrial efficiency differs by genotype, and whether such effects depend on substrate choice or dose.

## Data

The data for this study was collected from skeletal muscle mitochondria that are isolated from either non-transgenic or transgenic mice, measured during the mitochondrial energy transduction process. For our model we took into account two main factors: substrate type and dose.The primary factor we are interested in is genotype (non transgenic vs transgenic). Substrate and dose serve as design factors, and their interactions with genotype are of central interest in assessing whether genetic differences in mitochondrial function vary across energetic states or substrate conditions. 

The data we were given originally was in a wide format, so we transformed it into a tidy long format for analysis. We also dropped the basal values since they represent the idle state. Some values were missing so we dropped them.

## Model Rationale

## Model Implementation and Evaluation

## Results

## Limitations

## Conclusions

```{r, message=FALSE}

raw <- read_csv("data/JO2.csv", col_names = FALSE, show_col_types = FALSE)

header1 <- as.character(unlist(raw[1, ]))  # substrates in row 1
header2 <- as.character(unlist(raw[2, ]))  # doses in row 2

sub <- header1
sub[1] <- "Subject"
for (i in 2:length(sub)) {
  if (is.na(sub[i]) || sub[i] == "") sub[i] <- sub[i - 1]
}

dose <- header2
dose[1] <- NA  # first col is Subject

new_names <- c("Subject", paste(sub[-1], dose[-1], sep = "_"))

dat <- raw[-c(1, 2), ]
names(dat) <- new_names
dat <- dat |> mutate(across(-Subject, ~ suppressWarnings(as.numeric(.))))

data_long <- dat |>
  pivot_longer(
    cols = -Subject,
    names_to = c("Substrate", "Dose"),
    names_sep = "_",
    values_to = "JO2"
  ) |>
  filter(!(Dose %in% c("Basal", "-12.95"))) |>
  mutate(
    Genotype = if_else(str_detect(Subject, "^NT"), "NT", "Tg"),
    Dose_num = as.numeric(Dose), 
    Dose = factor(Dose,
                  levels = c("-13.65","-13.95","-14.19","-14.36","-14.49"),
                  ordered = TRUE)
  ) |>
  drop_na(JO2)   

```

```{r}
glimpse(data_long)
```

# Exploratory Data Analysis

```{r}
#| label: histograms

# Raw JO2
hist(
  data_long$JO2,
  breaks = 60,
  main = "Distribution of Raw JO2 Values",
  xlab = "Oxygen Consumption (JO2, pmol/min)",
  ylab = "Frequency",
  col = "lightblue",
  border = "white"
)

# Log10-transformed JO2
hist(
  log10(data_long$JO2),
  breaks = 60,
  main = "Distribution of Log Transformed JO2 Values",
  xlab = "Log(Oxygen Consumption, JO2)",
  ylab = "Frequency",
  col = "lightgreen",
  border = "white"
)

data_long <- data_long |>
  mutate(logJO2 = log10(JO2))

```

```{r}

# Keep Dose numeric
data_long <- data_long |>
  mutate(Dose = as.numeric(as.character(Dose)))

# Get all unique doses
all_doses <- sort(unique(data_long$Dose))

summary_data <- data_long |>
  group_by(Substrate, Genotype, Dose) |>
  summarise(
    mean_JO2 = mean(JO2, na.rm = TRUE),
    se = sd(JO2, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Plot individual lines with exact dose labels
ggplot(data_long, aes(x = Dose, y = JO2, color = Genotype, group = Subject)) +
  geom_line(alpha = 0.5) +
  facet_wrap(~ Substrate, scales = "free_y", labeller = label_wrap_gen(width = 15)) +
  scale_x_continuous(breaks = all_doses) +  # show all doses exactly
  theme_minimal() +
  labs(title = "JO2 across Dose by Substrate and Genotype") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    strip.text = element_text(size = 9)
  )

# Plot genotype means ± SE with exact dose labels
ggplot(summary_data, aes(Dose, mean_JO2, color = Genotype, group = Genotype)) +
  geom_line() + 
  geom_point() +
  geom_errorbar(aes(ymin = mean_JO2 - se, ymax = mean_JO2 + se), width = 0.1) +
  facet_wrap(~ Substrate, scales = "free_y", labeller = label_wrap_gen(width = 15)) +
  scale_x_continuous(breaks = all_doses) +  # show all doses exactly
  theme_minimal() +
  labs(title = "Mean JO2 ± SE", y = "Mean JO2") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    strip.text = element_text(size = 9)
  )

```

```{r}
data_long |>
  filter(Dose %in% c("Basal", "-13.65")) |>
  group_by(Genotype, Substrate, Dose) |>
  summarise(mean_JO2 = mean(JO2), se = sd(JO2)/sqrt(n()), .groups = "drop") |>
  ggplot(aes(x = Dose, y = mean_JO2, fill = Genotype)) +
  geom_col(position = position_dodge()) +
  geom_errorbar(aes(ymin = mean_JO2-se, ymax = mean_JO2+se),
                width = 0.2, position = position_dodge(0.9)) +
  facet_wrap(~Substrate, scales = "free_y") +
  theme_minimal()
```

```{r}
slopes <- data_long |>
  group_by(Subject, Genotype, Substrate) |>
  do(tidy(lm(JO2 ~ Dose_num, data = .))) |>
  filter(term == "Dose_num")

ggplot(slopes, aes(x = Substrate, y = estimate, fill = Genotype)) +
  geom_boxplot(alpha = 0.6, position = position_dodge()) +
  theme_minimal() +
  labs(y = "Slope of JO2 vs Dose", title = "Respiratory sensitivity by Genotype") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10)  # rotate labels
  )
```

```{r}
heat <- data_long |>
  group_by(Substrate, Dose, Genotype) |>
  summarise(mean_JO2 = mean(JO2), .groups = "drop")

ggplot(heat, aes(x = Dose, y = Substrate, fill = mean_JO2)) +
  geom_tile() +
  facet_wrap(~Genotype) +
  scale_fill_viridis_c() +
  theme_minimal() +
  labs(title = "Heatmap of mean JO2 across Substrates & Doses") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # rotate x labels
  )
```

# Model

Linear model on raw JO2 & Diagnostics

```{r}

# Linear model on raw JO2, ignoring subject correlation
lm_raw <- lm(JO2 ~ Substrate * Dose, data = data_long)

# Model summary
summary(lm_raw)

# ANOVA table (Type I by default)
anova(lm_raw)

# Type II/III sums of squares:
Anova(lm_raw, type = 2)  # Type II
Anova(lm_raw, type = 3)  # Type III

```

Marginal Model

```{r}
# Marginal (group-level) model: JO2 by genotype only
lm_marginal <- lm(JO2 ~ Genotype, data = data_long)

# Summary and ANOVA
summary(lm_marginal)
anova(lm_marginal)

# Multiple regression with genotype, substrate, dose, and interactions
lm_multi <- lm(JO2 ~ Genotype * Substrate * Dose, data = data_long)

# Type II/III ANOVA (from car package)
library(car)
Anova(lm_multi, type = 2)  # main effects after accounting for others
Anova(lm_multi, type = 3)  # tests each term with all interactions

```

Mixed Model

```{r}
# Mixed model: random intercept for each mouse
lmm <- lmer(JO2 ~ Genotype * Substrate * Dose + (1 | Subject), data = data_long)

# Summary
summary(lmm)

# Type II/III tests for fixed effects
anova(lmm, type = 3)  # Type III ANOVA table
```

# Results

```{r, warning=FALSE}
library(ggeffects)
library(ggplot2)

# Predictions across dose values for each genotype × substrate
pred <- ggpredict(lmm, terms = c("Dose [all]", "Genotype", "Substrate"))

# Plot fitted curves with CIs
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  facet_wrap(~facet, scales = "free_y") +
  theme_minimal() +
  labs(
    title = "Fitted JO2 vs Dose by Substrate and Genotype",
    x = "Dose (ΔGATP)", y = "Predicted JO2",
    color = "Genotype", fill = "Genotype"
  )
```

```{r}
library(emmeans)
library(dplyr)

# Estimated marginal means for each Substrate × Dose × Genotype
emm <- emmeans(lmm, ~ Genotype | Substrate * Dose)

# Compute differences Tg – NT
contrast_df <- contrast(emm, method = "revpairwise") %>%
  as.data.frame()

# Plot heatmap
ggplot(contrast_df, aes(x = Dose, y = Substrate, fill = estimate)) +
  geom_tile() +
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red", midpoint = 0,
    name = "Tg – NT difference"
  ) +
  theme_minimal() +
  labs(title = "Genotype Effect (Tg – NT) across \
       Substrates and Doses",
       x = "Dose (ΔGATP)", y = "Substrate")
```

```{r}
plot(lmm, resid(., type="pearson") ~ fitted(.), abline=0)

# QQ plot
qqnorm(resid(lmm))
qqline(resid(lmm))
```

# Conclusion

# Limitations and Future Work

\newpage

# Appendix
