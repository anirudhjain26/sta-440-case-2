---
title: "STA 440 Case 2"
author: "Krish Bansal, Lily Seelig, Anirudh Jain"
# format: pdf
format: 
  pdf:
    documentclass: article 
    fontsize: 11pt         
    classoption: oneside       
editor: visual
geometry: margin=1in
title-block-spacing: compact
execute: 
  echo: false
  warning: false
  message: false
---

```{r, message=FALSE}
# imports
library(readr)
library(tidyverse)
library(patchwork)
library(scales)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(broom)
```

# Introduction

# Data

```{r, message=FALSE}

raw <- read_csv("data/JO2.csv", col_names = FALSE, show_col_types = FALSE)

header1 <- as.character(unlist(raw[1, ]))  # substrates in row 1
header2 <- as.character(unlist(raw[2, ]))  # doses in row 2

sub <- header1
sub[1] <- "Subject"
for (i in 2:length(sub)) {
  if (is.na(sub[i]) || sub[i] == "") sub[i] <- sub[i - 1]
}

dose <- header2
dose[1] <- NA  # first col is Subject

new_names <- c("Subject", paste(sub[-1], dose[-1], sep = "_"))

dat <- raw[-c(1, 2), ]
names(dat) <- new_names
dat <- dat %>% mutate(across(-Subject, ~ suppressWarnings(as.numeric(.))))

data_long <- dat %>%
  pivot_longer(
    cols = -Subject,
    names_to = c("Substrate", "Dose"),
    names_sep = "_",
    values_to = "JO2"
  ) %>%
  mutate(
    Genotype = if_else(str_detect(Subject, "^NT"), "NT", "Tg"),
    # keep Basal as a category; make numeric where applicable
    Dose_num = suppressWarnings(as.numeric(Dose)),
    Dose = factor(Dose,
                  levels = c("Basal", "-12.95","-13.65","-13.95","-14.19","-14.36","-14.49"),
                  ordered = TRUE)
  ) %>%
  drop_na(JO2)   

```

```{r}
glimpse(data_long)
```

# Exploratory Data Analysis

```{r}
#| label: histogram 

#raw
hist(data_long$JO2, breaks=60, main="JO2 (raw)")

#log10
hist(log10(data_long$JO2), breaks=60, main="log10(JO2)")

```

```{r}
# subject-level spaghetti by substrate
ggplot(data_long, aes(x = Dose, y = JO2, color = Genotype, group = Subject)) +
  geom_line(alpha = 0.5) +
  facet_wrap(~ Substrate, scales = "free_y") +
  theme_minimal() +
  labs(title = "JO2 across Dose by Substrate and Genotype")

# genotype means ± SE per substrate×dose
summary_data <- data_long %>%
  group_by(Substrate, Dose, Genotype) %>%
  summarise(mean_JO2 = mean(JO2), se = sd(JO2)/sqrt(n()), .groups = "drop")

ggplot(summary_data, aes(Dose, mean_JO2, color = Genotype, group = Genotype)) +
  geom_line() + geom_point() +
  geom_errorbar(aes(ymin = mean_JO2 - se, ymax = mean_JO2 + se), width = 0.1) +
  facet_wrap(~ Substrate, scales = "free_y") +
  theme_minimal() +
  labs(title = "Mean JO2 ± SE", y = "Mean JO2")
```

```{r}
data_long %>%
  filter(Dose %in% c("Basal", "-12.95")) %>%
  group_by(Genotype, Substrate, Dose) %>%
  summarise(mean_JO2 = mean(JO2), se = sd(JO2)/sqrt(n()), .groups = "drop") %>%
  ggplot(aes(x = Dose, y = mean_JO2, fill = Genotype)) +
  geom_col(position = position_dodge()) +
  geom_errorbar(aes(ymin = mean_JO2-se, ymax = mean_JO2+se),
                width = 0.2, position = position_dodge(0.9)) +
  facet_wrap(~Substrate, scales = "free_y") +
  theme_minimal()
```

```{r}
slopes <- data_long %>%
  group_by(Subject, Genotype, Substrate) %>%
  do(tidy(lm(JO2 ~ Dose_num, data = .))) %>%
  filter(term == "Dose_num")

ggplot(slopes, aes(x = Substrate, y = estimate, fill = Genotype)) +
  geom_boxplot(alpha = 0.6, position = position_dodge()) +
  theme_minimal() +
  labs(y = "Slope of JO2 vs Dose", title = "Respiratory sensitivity by Genotype")
```

```{r}
heat <- data_long %>%
  group_by(Substrate, Dose, Genotype) %>%
  summarise(mean_JO2 = mean(JO2), .groups = "drop")

ggplot(heat, aes(x = Dose, y = Substrate, fill = mean_JO2)) +
  geom_tile() +
  facet_wrap(~Genotype) +
  scale_fill_viridis_c() +
  theme_minimal() +
  labs(title = "Heatmap of mean JO2 across Substrates & Doses")
```

# Model

# Results

# Conclusion

# Limitations and Future Work

\newpage

# Appendix
